# Copyright (c) 2023, Tech4dev and contributors
# For license information, please see license.txt

import unittest
import frappe
from frappe.test_runner import make_test_records


class TestEnrollment(unittest.TestCase):
    
    @classmethod
    def setUpClass(cls):
        """Set up test data"""
        frappe.set_user("Administrator")
        # Create test records if needed
        make_test_records("User")
        
        # Try to create Course records if Course doctype exists
        try:
            make_test_records("Course")
        except Exception as e:
            # If Course doctype doesn't exist, create a simple test course
            if not frappe.db.exists("Course", "TEST-COURSE-001"):
                try:
                    course = frappe.get_doc({
                        "doctype": "Course",
                        "course_name": "Test Course 001",
                        "course_code": "TEST-COURSE-001"
                    })
                    course.insert(ignore_permissions=True)
                except Exception as create_error:
                    pass  # Course doctype might not exist yet
        
    def setUp(self):
        """Set up before each test"""
        frappe.set_user("Administrator")
        # Clean up any existing test enrollments more thoroughly
        frappe.db.sql("DELETE FROM `tabEnrollment` WHERE student LIKE 'test%@example.com'")
        frappe.db.commit()
    
    def tearDown(self):
        """Clean up after each test"""
        # Clean up test data more thoroughly
        frappe.db.sql("DELETE FROM `tabEnrollment` WHERE student LIKE 'test%@example.com'")
        frappe.db.commit()
   
    def test_enrollment_update(self):
        """Test enrollment update functionality"""
        # Create enrollment
        enrollment = frappe.get_doc({
            "doctype": "Enrollment",
            "student": "test7@example.com",
            "course": "TEST-COURSE-001",
            "enrollment_date": frappe.utils.today(),
            "status": "Active"
        })
        enrollment.insert(ignore_permissions=True)
        
        # Update enrollment status
        enrollment.status = "Completed"
        enrollment.save(ignore_permissions=True)
        
        # Verify update
        updated_enrollment = frappe.get_doc("Enrollment", enrollment.name)
        self.assertEqual(updated_enrollment.status, "Completed")
    